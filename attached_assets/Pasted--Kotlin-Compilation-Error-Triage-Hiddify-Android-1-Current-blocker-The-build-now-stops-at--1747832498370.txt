# Kotlin Compilation Error Triage â€“ Hiddify Android

## 1Â Â Current blocker

The build now stops at **`:app:compileReleaseKotlin`** with hundreds of â€œ*unresolved reference* / *typeâ€‘mismatch*â€ messages.â€¯These come from three root causes:

* **Outâ€‘ofâ€‘date generated Room stubs** after our AGPÂ & Kotlin upgrade
* **Missing/renamed project classes** (e.g. `TrafficStats`, `PingUtils#pingAllServersAsync`)
* **Protocol handler subclasses** that donâ€™t implement the new abstract API

---

## 2Â Â Fix in biteâ€‘size passes

\###Â 2â€‘1Â Â Clean & reâ€‘generate kapt code

```bash
./gradlew clean
rm -rf app/build/tmp/kapt3            # old stubs
```

Reâ€‘build once after every few edits to surface only the next group of errors:

```bash
./gradlew :app:compileReleaseKotlin
```

\###Â 2â€‘2Â Â Room entity / DAO issues

| Offending file                       | Error snippet                                               | What to change                                                                                                                                              |
| ------------------------------------ | ----------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `AppSettings.kt`                     | `Cannot find setter for field id`                           | Make the property **mutable** or supply a custom setter:<br>`@PrimaryKey(autoGenerate = true) var id: Int = 0`                                              |
| AnyÂ DAOÂ method returning `Object`    | â€œNot sure how to convert a Cursorâ€¦â€                         | Give them proper **suspend** / Flow types, e.g.<br>`@Query("SELECT * FROM server WHERE id = :serverId") suspend fun getServerById(serverId: Long): Server?` |
| Warning â€œmultiple good constructorsâ€ | Add `@Ignore` to secondary ctors you donâ€™t want Room to use |                                                                                                                                                             |

After fixing entities/DAOs, run `./gradlew :app:kaptGenerateStubsReleaseKotlin` once to confirm Room stops complaining.

\###Â 2â€‘3Â Â Kotlin stdâ€‘lib type mismatches

* `HiddifyNGApplication.kt:124â€“125`  â€” cast prefs values explicitly:

  ```kotlin
  val lastUpdateTimestamp: Long = prefs.getLong(KEY_LAST_UPDATE, 0L)
  val updateInterval: Long = prefs.getInt(KEY_UPDATE_INTERVAL, 24).toLong()
  ```
* Replace `/` on `BigDecimal` with `divide()`.

\###Â 2â€‘4Â Â Missing helper classes / IDs
The upgrade path dropped several convenience wrappers.  Either:

1. **Reâ€‘import them** from the original Hiddify repo; **or**
2. **Commentâ€‘out** their callers for now, then add your own replacements.

Quick grep list:

```bash
grep -R "\<TrafficStats\>\|bestServer\|pingAllServersAsync" app/src/main/java
```

\###Â 2â€‘5Â Â ProtocolHandler hierarchy
`ProtocolHandler` is now **abstract**.  Every subclass must:

```kotlin
class HysteriaProtocol(private val server: Server) : ProtocolHandler() {
    override fun getProtocolName() = "hysteria"
    override fun createOutboundConfig() = â€¦
    // implement the other abstract funcs
}
```

Add a **primary constructor** and implement **all** abstract members (`createOutboundConfig`, `createProtocolSettings`, `createStreamSettings`).

---

## 3Â Â Gradle / Kotlin buildÂ flags recap

```gradle
android {
    compileSdk 35
    buildFeatures { buildConfig true }
}

kotlinOptions { jvmTarget = "17" }
```

Make sure they appear **once** in *app/build.gradle*.

---

## 4Â Â Iteration checklist

* [ ] Build cleans without Room errors
* [ ] No unresolved references in `MainActivity.kt`
* [ ] All protocol handlers compile
* [ ] `./gradlew assembleRelease` finishes

> ğŸ’¡Â Keep a live watcher: `./gradlew --continuous compileReleaseKotlin` â€“ it recompiles as soon as you save.
